<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>InspireApp â€“ Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7c3aed" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* âœ… Minimum garanti stiller (style.css olsa bile Ã§alÄ±ÅŸsÄ±n) */
    .hidden { display: none !important; }

    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .top-bar{
      position: sticky; top: 0;
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .icon-button{
      width: 42px; height: 42px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.65);
      font-size: 18px;
    }
    #topTitle{ font-weight: 800; letter-spacing: 6px; font-size: 24px; }

    .content{
      min-height: calc(100vh - 72px);
      padding: 22px 18px 40px;
      background: linear-gradient(180deg, #d8b4fe 0%, #e9d5ff 30%, #dbeafe 100%);
    }
    .panel{
      max-width: 720px;
      margin: 0 auto;
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 18px;
      padding: 18px 16px;
      backdrop-filter: blur(10px);
    }
    .panel h1{ margin: 0 0 8px; font-size: 34px; }
    .panel p{ margin: 0 0 14px; font-size: 20px; color: rgba(0,0,0,0.65); line-height: 1.35; }

    .row{ display:flex; gap:12px; align-items:flex-end; flex-wrap: wrap; }
    textarea{
      width: min(520px, 100%);
      min-height: 76px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.20);
      background: rgba(255,255,255,0.80);
      font-size: 18px;
      outline: none;
      resize: vertical;
    }
    .btn{
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.20);
      background: rgba(255,255,255,0.80);
      font-size: 18px;
      cursor: pointer;
      white-space: nowrap;
    }
    .status{
      margin-top: 10px;
      font-size: 18px;
      color: rgba(0,0,0,0.75);
      min-height: 26px;
    }
    .result{
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.65);
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.45;
    }

    /* âœ… Mini plan/kredi satÄ±rÄ± */
    .mini-bar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      margin: 6px 0 12px;
      font-size: 16px;
      color: rgba(0,0,0,0.75);
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.60);
    }

    /* ONBOARDING */
    .onboarding-overlay{
      position: fixed; inset: 0;
      display:flex;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,0.30);
      z-index: 9999;
    }
    .onboarding-card{
      width: min(420px, calc(100vw - 32px));
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .onboarding-card h2{ margin: 0 0 10px; }
    .onboarding-card select,
    .onboarding-card input{
      width: 100%;
      padding: 12px;
      margin: 0 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.95);
      font-size: 16px;
      outline: none;
    }
    .onboarding-card button{
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #7c3aed;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>

<body>

<!-- ðŸ”’ APP BAÅžTA GÄ°ZLÄ° -->
<div id="app" class="hidden">

  <!-- ÃœST BAR -->
  <header class="top-bar">
    <button id="menuToggle" class="icon-button">â‹¯</button>
    <div id="topTitle">INSPIREAPP</div>
    <button id="helpToggle" class="icon-button">?</button>
  </header>

  <!-- âœ… ANA Ä°Ã‡ERÄ°K -->
  <main class="content">
    <section class="panel">
      <h1>ðŸŽ¬ Trend Kopya Makinesi</h1>
      <p>BeÄŸendiÄŸin bir trend / video fikrini yaz; InspireApp bunu senin niÅŸine gÃ¶re yeniden yazar.</p>

      <!-- âœ… KREDÄ° / REKLAM BAR -->
      <div class="mini-bar">
        <span id="creditsPill" class="pill">Kalan puan: 4</span>
        <button id="watchAdBtn" class="btn">Reklam izle +1 puan</button>
      </div>

      <div class="row">
        <textarea id="trendInput" placeholder="Ã–rn: okul bitti"></textarea>
        <button id="trendGenerateBtn" class="btn">Trend kopyasÄ±nÄ± oluÅŸtur</button>
      </div>

      <div id="trendStatus" class="status"></div>
      <div id="trendResult" class="result hidden"></div>
    </section>
  </main>

</div>

<!-- ================= ONBOARDING ================= -->
<div id="onboardingOverlay" class="onboarding-overlay hidden">
  <div class="onboarding-card">

    <!-- STEP 1: DÄ°L -->
    <div id="onboardStepLang">
      <h2>Dil seÃ§in</h2>
      <select id="onboardLangSelect">
        <option value="tr">TÃ¼rkÃ§e</option>
        <option value="en">English</option>
      </select>
      <button id="onboardLangSaveBtn">Devam</button>
    </div>

    <!-- STEP 2: EMAIL -->
    <div id="onboardStepEmail" class="hidden">
      <h2>E-posta ve ÅŸifre</h2>
      <input id="onboardEmailInput" type="email" placeholder="mail@example.com" />
      <input id="onboardPasswordInput" type="password" placeholder="Åžifre (min 6)" />
      <button id="onboardEmailSaveBtn">Sohbete baÅŸla</button>
    </div>

  </div>
</div>

<script>
/* =========================
   === STORAGE KEYS       ===
   ========================= */
const EMAIL_KEY   = "inspireapp_email_v1";
const LANG_KEY    = "inspireapp_lang_v1";
const CREDITS_KEY = "inspireapp_credits_v1";

const AD_COUNT_KEY = "inspireapp_daily_ad_count_v1";
const AD_DATE_KEY  = "inspireapp_daily_ad_date_v1";

const MAX_FREE_CREDITS = 4;
const DAILY_AD_LIMIT   = 400;

/* =========================
   === STATE              ===
   ========================= */
const state = {
  credits: MAX_FREE_CREDITS
};

function loadCredits() {
  const c = parseInt(localStorage.getItem(CREDITS_KEY) || "", 10);
  state.credits = Number.isFinite(c) ? c : MAX_FREE_CREDITS;
}
function saveCredits() {
  localStorage.setItem(CREDITS_KEY, String(state.credits));
}
function updateCreditsUI() {
  const el = document.getElementById("creditsPill");
  if (el) el.textContent = (getLang()==="en" ? "Credits: " : "Kalan puan: ") + state.credits;
}

/* =========================
   === NETWORK SETTINGS   ===
   ========================= */
const API_TIMEOUT_MS = 20000;

async function fetchWithTimeout(url, options = {}, timeoutMs = API_TIMEOUT_MS) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { ...options, signal: controller.signal });
    return res;
  } finally {
    clearTimeout(id);
  }
}

/* =========================
   === I18N (MIN)         ===
   ========================= */
const STR = {
  tr: {
    needText: "LÃ¼tfen bir trend / fikir yaz.",
    adWatching: "Reklam izleniyor... Bitince sonuÃ§ gelecek.",
    generating: "Ãœretiliyor...",
    done: "HazÄ±r.",
    fail: "Ãœretim baÅŸarÄ±sÄ±z. Tekrar dene.",
    offline: "Åžu an offline/endpoint yok. GeÃ§ici yerel sonuÃ§ Ã¼retildi.",
    adLimit: (n) => `GÃ¼nlÃ¼k reklam limiti doldu. (Limit: ${n})`,
    creditAdded: "+1 puan eklendi."
  },
  en: {
    needText: "Please type a trend / idea.",
    adWatching: "Ad is playing... Result will arrive when it finishes.",
    generating: "Generating...",
    done: "Done.",
    fail: "Generation failed. Try again.",
    offline: "Offline/no endpoint. Temporary local result generated.",
    adLimit: (n) => `Daily ad limit reached. (Limit: ${n})`,
    creditAdded: "+1 credit added."
  }
};

function getLang() {
  return localStorage.getItem(LANG_KEY) || "tr";
}
function t(key) {
  const lang = getLang();
  return (STR[lang] && STR[lang][key]) ? STR[lang][key] : STR.tr[key];
}

/* =========================
   === REWARDED AD GATE   ===
   =========================
   - purpose: "credit"   => +1 puan
   - purpose: "generate" => krediyi ELLEME, iÅŸi Ã§alÄ±ÅŸtÄ±r
*/
let __rewardPurpose = null;
let __pendingRewardAction = null;

function startRewardAd(purpose, actionFn) {
  __rewardPurpose = purpose;
  __pendingRewardAction = (typeof actionFn === "function") ? actionFn : null;

  // âœ… Android SDK varsa (senin WebView tarafÄ±n)
  if (window.AndroidAds && typeof window.AndroidAds.showRewardedAd === "function") {
    window.AndroidAds.showRewardedAd();
    return;
  }

  // âœ… EÄŸer sen window.showRewardedAd yazdÄ±ysan
  if (typeof window.showRewardedAd === "function") {
    Promise.race([
      window.showRewardedAd(),
      new Promise(resolve => setTimeout(resolve, 8000))
    ]).then(() => handleRewardedAdFinished());
    return;
  }

  // âœ… SDK yoksa takÄ±lmasÄ±n (test)
  setTimeout(() => handleRewardedAdFinished(), 800);
}

function canGrantAdToday() {
  const today = new Date().toISOString().slice(0, 10);
  const storedDate = localStorage.getItem(AD_DATE_KEY);
  let storedCount = parseInt(localStorage.getItem(AD_COUNT_KEY) || "0", 10);

  if (storedDate !== today) storedCount = 0;

  if (storedCount >= DAILY_AD_LIMIT) return { ok:false, count: storedCount };

  storedCount += 1;
  localStorage.setItem(AD_DATE_KEY, today);
  localStorage.setItem(AD_COUNT_KEY, String(storedCount));

  return { ok:true, count: storedCount };
}

function grantReward() {
  // âœ… generate: kredi ELLEME, iÅŸi Ã§alÄ±ÅŸtÄ±r
  if (__rewardPurpose === "generate" && typeof __pendingRewardAction === "function") {
    const fn = __pendingRewardAction;
    __rewardPurpose = null;
    __pendingRewardAction = null;
    try { fn(); } catch {}
    return;
  }

  // âœ… credit: +1 puan
  if (__rewardPurpose === "credit") {
    __rewardPurpose = null;
    __pendingRewardAction = null;

    const limit = canGrantAdToday();
    if (!limit.ok) {
      alert(t("adLimit")(DAILY_AD_LIMIT));
      return;
    }

    state.credits += 1;
    saveCredits();
    updateCreditsUI();
    alert(t("creditAdded"));
    return;
  }

  // baÅŸka amaÃ§ yoksa hiÃ§bir ÅŸey yapma
}

function handleRewardedAdFinished() {
  grantReward();
}

/* âœ… ANDROID CALLBACK ALIAS: Android hangi ismi Ã§aÄŸÄ±rÄ±rsa Ã§aÄŸÄ±rsÄ±n Ã§alÄ±ÅŸsÄ±n */
window.onRewardedAdCompleted = function () { handleRewardedAdFinished(); };
window.onRewardedAdRewarded  = function () { handleRewardedAdFinished(); };
window.onRewardEarned        = function () { handleRewardedAdFinished(); };
window.__onRewardedAdCompletedFromAndroid = function () { handleRewardedAdFinished(); };
window.__onRealAdReward = function () { handleRewardedAdFinished(); };

/* =========================
   === APP INIT           ===
   ========================= */
window.initApp = function initApp() {
  loadCredits();
  updateCreditsUI();

  const input  = document.getElementById("trendInput");
  const btn    = document.getElementById("trendGenerateBtn");
  const status = document.getElementById("trendStatus");
  const result = document.getElementById("trendResult");
  const watchAdBtn = document.getElementById("watchAdBtn");

  // âœ… Reklam izle +1 puan
  if (watchAdBtn) {
    watchAdBtn.onclick = () => {
      startRewardAd("credit");
    };
  }

  // âœ… Trend Ã¼ret: Free -> reklam -> Ã¼ret (kredi dÃ¼ÅŸmez)
  btn.onclick = async () => {
    const text = (input.value || "").trim();
    if (!text) {
      status.textContent = t("needText");
      result.classList.add("hidden");
      return;
    }

    btn.disabled = true;
    status.textContent = t("adWatching");
    result.classList.add("hidden");
    result.textContent = "";

    const runGenerate = async () => {
      try {
        status.textContent = t("generating");

        let outText = "";
        let usedOffline = false;

        try {
          const res = await fetchWithTimeout("/api/trend-copy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ trend: text, lang: getLang() })
          });

          if (!res.ok) throw new Error("bad_status");
          const data = await res.json();
          outText = (data && (data.result || data.text || data.output)) ? (data.result || data.text || data.output) : "";
          if (!outText) throw new Error("empty");
        } catch (e) {
          usedOffline = true;
          outText = localFallbackTrendCopy(text, getLang());
        }

        result.textContent = outText + (usedOffline ? ("\n\n(" + t("offline") + ")") : "");
        result.classList.remove("hidden");
        status.textContent = t("done");
      } catch (e) {
        status.textContent = t("fail");
        result.classList.add("hidden");
      } finally {
        btn.disabled = false;
      }
    };

    // Reklam -> generate (kredi yok)
    startRewardAd("generate", runGenerate);
  };

  // MenÃ¼/Help placeholder
  const menuToggle = document.getElementById("menuToggle");
  const helpToggle = document.getElementById("helpToggle");
  if (menuToggle) menuToggle.onclick = () => {};
  if (helpToggle) helpToggle.onclick = () => {};
};

/* âœ… Offline fallback (boÅŸ dÃ¶nmesin diye) */
function localFallbackTrendCopy(trend, lang) {
  if (lang === "en") {
    return [
      `Trend: "${trend}"`,
      ``,
      `1) Hook: â€œI thought it would be easyâ€¦ it wasnâ€™t.â€`,
      `2) Script: (0-2s) show the moment â†’ (2-7s) twist â†’ (7-12s) quick tips â†’ (12-15s) punchline.`,
      `3) Text overlays: â€œPOV: ${trend}â€, â€œWait for itâ€¦â€, â€œThis changed everythingâ€`,
      `4) CTA: â€œComment your versionâ€`,
      `5) 5 Variations: funny / emotional / tutorial / reaction / storytime`
    ].join("\n");
  }

  return [
    `Trend: "${trend}"`,
    ``,
    `1) Hook: â€œKolay sandÄ±mâ€¦ deÄŸilmiÅŸ.â€`,
    `2) AkÄ±ÅŸ: (0-2sn) olay anÄ± â†’ (2-7sn) ters kÃ¶ÅŸe â†’ (7-12sn) hÄ±zlÄ± ipuÃ§larÄ± â†’ (12-15sn) final.`,
    `3) YazÄ± Ã¶nerileri: â€œPOV: ${trend}â€, â€œBekleâ€¦â€, â€œBunu kimse sÃ¶ylemiyorâ€`,
    `4) CTA: â€œSen olsan ne yapardÄ±n?â€`,
    `5) 5 Varyasyon: komik / duygusal / Ã¶ÄŸretici / tepki / hikaye`
  ].join("\n");
}

/* ================= ONBOARDING LOGIC ================= */
const app = document.getElementById("app");
const onboarding = document.getElementById("onboardingOverlay");

const stepLang = document.getElementById("onboardStepLang");
const stepEmail = document.getElementById("onboardStepEmail");

const langBtn = document.getElementById("onboardLangSaveBtn");
const emailBtn = document.getElementById("onboardEmailSaveBtn");

function startApp() {
  onboarding.classList.add("hidden");
  app.classList.remove("hidden");

  if (typeof window.initApp === "function") {
    window.initApp();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const savedEmail = localStorage.getItem(EMAIL_KEY);

  if (savedEmail) {
    startApp();
  } else {
    onboarding.classList.remove("hidden");
    app.classList.add("hidden");
    stepLang.classList.remove("hidden");
    stepEmail.classList.add("hidden");
  }
});

langBtn.onclick = () => {
  const lang = document.getElementById("onboardLangSelect").value;
  localStorage.setItem(LANG_KEY, lang);

  stepLang.classList.add("hidden");
  stepEmail.classList.remove("hidden");
};

emailBtn.onclick = () => {
  const email = document.getElementById("onboardEmailInput").value.trim();
  const pass  = document.getElementById("onboardPasswordInput").value.trim();

  if (!email || pass.length < 6) {
    alert(getLang() === "en" ? "Email and password required" : "E-posta ve ÅŸifre zorunlu");
    return;
  }

  localStorage.setItem(EMAIL_KEY, email);
  startApp();
};
</script>

<!-- SERVICE WORKER (âœ… relative path) -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
