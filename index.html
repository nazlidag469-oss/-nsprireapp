<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>InspireApp â€“ Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- PWA: Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- PWA: Tema rengi -->
    <meta name="theme-color" content="#7c3aed" />

    <!-- CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- PRO PANELÄ° Ä°Ã‡Ä°N EK STÄ°LLER -->
    <style>
      .pro-tools-layout {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }
      .pro-tools-menu {
        width: 36%;
        max-width: 220px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .pro-tool-link {
        width: 100%;
        text-align: left;
        border: none;
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 14px;
        background: rgba(124, 58, 237, 0.12);
        color: #ffffff;
      }
      .pro-tool-link.active {
        background: #7c3aed;
        color: #ffffff;
        font-weight: 600;
      }
      .pro-tools-content {
        flex: 1;
        min-width: 0;
      }
      .pro-tool-page {
        display: none;
      }
      .pro-tool-page.active {
        display: block;
      }

      @media (max-width: 768px) {
        .pro-tools-layout {
          flex-direction: column;
        }
        .pro-tools-menu {
          width: 100%;
          max-width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- ÃœST BAR -->
      <header class="top-bar">
        <button id="menuToggle" class="icon-button">â‹¯</button>
        <div id="topTitle" class="top-title">INSPIREAPP</div>
        <button id="helpToggle" class="icon-button">?</button>
      </header>

      <!-- SOL PANEL -->
      <aside id="sidebar" class="sidebar hidden">
        <div class="sidebar-header">
          <h2 id="sidebarTitle">Hesap &amp; Sohbetler</h2>
        </div>

        <section class="sidebar-section">
          <h3 id="sidebarUserTitle">KullanÄ±cÄ±</h3>

          <p class="muted small-label" id="sidebarEmailLabel">E-posta</p>
          <div id="accountEmail" class="sidebar-email">KayÄ±tlÄ± deÄŸil</div>

          <button id="changeEmailBtn" class="pill-button small">
            <span id="changeEmailBtnText">E-postayÄ± deÄŸiÅŸtir</span>
          </button>

          <p class="muted small-label" id="sidebarStatusLabel">Durum</p>
          <div id="planStatus" class="sidebar-plan-status">Plan: Ãœcretsiz</div>

          <div id="subscribeBlock">
            <button id="subscribeBtn" class="pill-button primary small">
              <b id="subscribeBtnText">PRO'ya geÃ§</b>
            </button>
          </div>
        </section>

        <section class="sidebar-section">
          <h3 id="sidebarChatsTitle">Sohbetler</h3>
          <button id="newChatBtn" class="pill-button">
            <span id="newChatBtnText">+ Yeni sohbet</span>
          </button>
          <div id="conversationList" class="conversation-list"></div>
        </section>

        <section class="sidebar-section">
          <h3 id="sidebarPanelsTitle">Paneller</h3>
          <button class="side-btn" data-panel="chat" id="btnPanelChat">
            ğŸ’¬ <span id="btnPanelChatText">Sohbet</span>
          </button>
          <button class="side-btn" data-panel="trends" id="btnPanelTrends">
            ğŸ”¥ <span id="btnPanelTrendsText">Trend AkÄ±mÄ±</span>
          </button>
          <button class="side-btn" data-panel="series" id="btnPanelSeries">
            ğŸ“… <span id="btnPanelSeriesText">30 GÃ¼nlÃ¼k Seri</span>
          </button>
          <button class="side-btn" data-panel="hook" id="btnPanelHook">
            âš¡ <span id="btnPanelHookText">Hook LaboratuvarÄ±</span>
          </button>
          <button class="side-btn" data-panel="copy" id="btnPanelCopy">
            ğŸ¬ <span id="btnPanelCopyText">Trend Kopya Makinesi</span>
          </button>
          <button class="side-btn" data-panel="pro" id="btnPanelPro">
            â­ <span id="btnPanelProText">PRO AraÃ§larÄ±</span>
          </button>
        </section>

        <button id="helpToggle2" class="help-btn">
          <span id="helpToggle2Text">â“ YardÄ±m</span>
        </button>
      </aside>

      <!-- SAÄ YARDIM PANELÄ° -->
      <aside id="helpPanel" class="help-panel hidden">
        <h2 id="helpTitle">Bilgi &amp; Destek</h2>

        <h3 id="helpAppTitle">Uygulama</h3>
        <p id="helpAppText1">
          InspireApp, kÄ±sa video Ã¼reticileri iÃ§in yapay zekÃ¢ destekli
          <b>profesyonel fikir oluÅŸturma + akÄ±m analiz + iÃ§erik planlama</b>
          aracÄ±dÄ±r.
        </p>
        <p id="helpAppText2">
          YouTube Shorts, TikTok, Instagram Reels iÃ§in Ã¶zel fikir, hook,
          baÅŸlÄ±k, trend kopyalama ve iÃ§erik akÄ±ÅŸÄ± Ã¼retir.
        </p>

        <h3 id="helpFreeTitle">Ãœcretsiz Plan</h3>
        <p id="helpFreeText">GÃ¼nlÃ¼k 4 puan. Reklam izleyerek artÄ±rÄ±labilir.</p>

        <h3 id="helpProTitle">PRO Plan</h3>
        <p id="helpProText">
          Fiyat bilgisi ve Ã¶deme, <b>PRO'ya geÃ§</b> butonuna bastÄ±ÄŸÄ±nÄ±zda
          aÃ§Ä±lan ekranda gÃ¶sterilir (Google Play Ã¼zerinden satÄ±n alma).
        </p>

        <h3 id="helpSupportTitle">Destek</h3>
        <p id="helpSupportText"><b>E-posta:</b> insprireappdestek@gmail.com</p>

        <button id="closeHelpBtn" class="pill-button">
          <span id="closeHelpBtnText">Kapat</span>
        </button>
      </aside>

      <!-- ANA BÃ–LÃœM -->
      <main class="chat-area">
        <!-- TRENDLER PANELÄ° -->
        <section id="panel-trends" class="panel hidden">
          <h2 id="trendsTitle" class="panel-title">ğŸ”¥ Trendler (Bu Hafta)</h2>
          <button id="refreshTrendsBtn" class="pill-button primary small">
            <span id="refreshTrendsBtnText">Trendleri Yenile</span>
          </button>
          <ul id="trendsList" class="trends-list"></ul>
        </section>

        <!-- 30 GÃœNLÃœK SERÄ° PANELÄ° -->
        <section id="panel-series" class="panel hidden">
          <h2 id="seriesTitle" class="panel-title">ğŸ“… 30 GÃ¼nlÃ¼k Seri PlanÄ±</h2>
          <p class="muted" id="seriesDesc">
            Bir konu gir, InspireApp sana 30 gÃ¼nlÃ¼k kÄ±sa video planÄ± Ã§Ä±karsÄ±n.
          </p>
          <textarea
            id="seriesTopic"
            rows="3"
            placeholder="Ã–rn: SaÄŸlÄ±klÄ± yemek, motivasyon videolarÄ±..."
          ></textarea>
          <button id="seriesGenerate" class="pill-button primary">
            <span id="seriesGenerateText">30 gÃ¼nlÃ¼k planÄ± oluÅŸtur</span>
          </button>
          <pre id="seriesResult" class="panel-result"></pre>
        </section>

        <!-- HOOK LABORATUVARI PANELÄ° -->
        <section id="panel-hook" class="panel hidden">
          <h2 id="hookTitle" class="panel-title">âš¡ Hook LaboratuvarÄ±</h2>
          <p class="muted" id="hookDesc">
            Konunu yaz; ilk 3 saniyede izleyiciyi Ã§eken gÃ¼Ã§lÃ¼ giriÅŸ cÃ¼mleleri
            (hook) Ã¼retelim.
          </p>
          <textarea
            id="hookTopic"
            rows="3"
            placeholder="Ã–rn: Ã–ÄŸrenciler iÃ§in verimli ders Ã§alÄ±ÅŸma"
          ></textarea>
          <button id="hookGenerate" class="pill-button primary">
            <span id="hookGenerateText">Hook Ã¶nerilerini Ã¼ret</span>
          </button>
          <pre id="hookResult" class="panel-result"></pre>
        </section>

        <!-- TREND KOPYA MAKÄ°NESÄ° PANELÄ° -->
        <section id="panel-copy" class="panel hidden">
          <h2 id="copyTitle" class="panel-title">ğŸ¬ Trend Kopya Makinesi</h2>
          <p class="muted" id="copyDesc">
            BeÄŸendiÄŸin bir trend / video fikrini yaz; InspireApp bunu senin
            niÅŸine gÃ¶re yeniden yazar.
          </p>
          <textarea
            id="copyTopic"
            rows="3"
            placeholder="Ã–rn: Åu videoyu kendi marka tonuma uyarlamak istiyorum..."
          ></textarea>
          <button id="copyGenerate" class="pill-button primary">
            <span id="copyGenerateText">Trend kopyasÄ±nÄ± oluÅŸtur</span>
          </button>
          <pre id="copyResult" class="panel-result"></pre>
        </section>

        <!-- â­â­ PRO PANELÄ° â­â­ -->
        <section id="panel-pro" class="panel hidden">
          <h2 id="proPanelTitle" class="panel-title">â­ PRO AraÃ§larÄ±</h2>
          <p id="proPanelDesc" class="muted">
            Bu bÃ¶lÃ¼mdeki araÃ§lar PRO kullanÄ±cÄ±lar iÃ§in tasarlandÄ±. Ãœcretsiz
            planda Ã§alÄ±ÅŸÄ±r ama kÄ±sÄ±tlÄ± iÃ§erik dÃ¶ner; PROâ€™da tam gÃ¼Ã§ aÃ§Ä±lÄ±r.
          </p>

          <div class="pro-tools-layout">
            <div class="pro-tools-menu">
              <button class="pro-tool-link" data-pro-tool="tool1" id="proMenuTool1">
                1) Rakip Video Analizi
              </button>
              <button class="pro-tool-link" data-pro-tool="tool3" id="proMenuTool3">
                2) Kitle Ä°Ã§gÃ¶rÃ¼ Analizi
              </button>
              <button class="pro-tool-link" data-pro-tool="tool5" id="proMenuTool5">
                3) Sessiz Video Ä°Ã§erik Ãœreticisi
              </button>
            </div>

            <div class="pro-tools-content">
              <div class="card pro-tool-page" data-pro-page="tool1">
                <h3 id="proTool1Title">1) Rakip Video Analizi</h3>
                <p id="proTool1Desc" class="muted">
                  TikTok / Reels / Shorts linki veya aÃ§Ä±klamasÄ±nÄ± gir.
                </p>
                <textarea
                  id="proCompetitorInput"
                  rows="3"
                  placeholder="Ã–rn: TikTok linki veya rakip videonun aÃ§Ä±klamasÄ±..."
                ></textarea>
                <button id="proCompetitorBtn" class="pill-button primary">
                  <span id="proCompetitorBtnText">Rakip videoyu analiz et (PRO)</span>
                </button>
                <pre id="proCompetitorResult" class="panel-result"></pre>
              </div>

              <div class="card pro-tool-page" data-pro-page="tool3">
                <h3 id="proTool3Title">3) Kitle Ä°Ã§gÃ¶rÃ¼ Analizi</h3>
                <p id="proTool3Desc" class="muted">
                  Hedef kitleni tek cÃ¼mle ile anlat.
                </p>
                <textarea
                  id="proAudienceInput"
                  rows="3"
                  placeholder="Ã–rn: 17â€“24 yaÅŸ, fitness niÅŸinde hedef kitlem var."
                ></textarea>
                <button id="proAudienceBtn" class="pill-button primary">
                  <span id="proAudienceBtnText">Kitle iÃ§gÃ¶rÃ¼sÃ¼ Ã¼ret (PRO)</span>
                </button>
                <pre id="proAudienceResult" class="panel-result"></pre>
              </div>

              <div class="card pro-tool-page" data-pro-page="tool5">
                <h3 id="proTool5Title">5) Sessiz Video Ä°Ã§erik Ãœreticisi</h3>
                <p id="proTool5Desc" class="muted">
                  YÃ¼zÃ¼nÃ¼ gÃ¶stermeden, ses kullanmadan iÃ§erik Ã¼retmek istiyorsan konunu yaz.
                </p>
                <textarea
                  id="proSilentInput"
                  rows="3"
                  placeholder="Ã–rn: Sessiz motivasyon videolarÄ± ile bÃ¼yÃ¼mek istiyorum."
                ></textarea>
                <button id="proSilentBtn" class="pill-button primary">
                  <span id="proSilentBtnText">Sessiz iÃ§erik fikirleri Ã¼ret (PRO)</span>
                </button>
                <pre id="proSilentResult" class="panel-result"></pre>
              </div>
            </div>
          </div>
        </section>

        <!-- SOHBET -->
        <section id="panel-chat" class="panel">
          <h2 id="chatTitle" class="panel-title">ğŸ’¬ Sohbet</h2>

          <div id="chatMessages" class="chat-messages"></div>

          <div class="credits-row">
            <span id="planLabel" class="muted"></span>
            <span id="creditsLabel" class="muted"></span>
            <button id="watchAdBtn" class="pill-button small">
              <span id="watchAdBtnText">Reklam izle +1 puan</span>
            </button>
          </div>

          <div class="controls">
            <input id="topicInput" type="text" placeholder="Konu (Ã¶rn: moda)" />
            <select id="platformSelect">
              <option value="youtube">YouTube Shorts</option>
              <option value="tiktok">TikTok</option>
              <option value="instagram">Instagram Reels</option>
            </select>
            <select id="langSelect"></select>
          </div>

          <form id="chatForm" class="chat-input-row">
            <button type="button" id="voiceBtn" class="circle-button">ğŸ¤</button>
            <button type="button" id="cameraBtn" class="circle-button">ğŸ“·</button>
            <textarea id="messageInput" rows="1" placeholder="Mesaj yaz..."></textarea>
            <button type="submit" id="sendBtn" class="pill-button primary">
              <span id="sendBtnText">GÃ¶nder</span>
            </button>
          </form>

          <div id="loading" class="loading hidden">YÃ¼kleniyor...</div>
        </section>
      </main>

      <!-- ONBOARDING -->
      <div id="onboardingOverlay" class="onboarding-overlay hidden">
        <div class="onboarding-card">
          <h1 id="onboardTitle" class="onboarding-title">INSPIREAPP</h1>

          <div id="onboardStepLang">
            <h2 id="onboardLangTitle">Dil seÃ§in</h2>
            <select id="onboardLangSelect"></select>
            <button id="onboardLangSaveBtn" class="pill-button primary">
              <span id="onboardLangSaveBtnText">Devam</span>
            </button>
          </div>

          <div id="onboardStepEmail" class="hidden">
            <h2 id="onboardEmailTitle">E-posta adresiniz</h2>
            <input id="onboardEmailInput" type="email" placeholder="ornek@mail.com" />
            <input id="onboardPasswordInput" type="password" placeholder="Åifre (en az 6 karakter)" />
            <button id="onboardEmailSaveBtn" class="pill-button primary">
              <span id="onboardEmailSaveBtnText">Sohbete baÅŸla</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Kamera iÃ§in gizli input -->
    <input
      id="cameraFileInput"
      type="file"
      accept="image/*"
      capture="environment"
      style="display: none"
    />

    <!-- GENEL MODAL ARKA PLANI -->
    <div id="modalBackdrop" class="backdrop hidden"></div>

    <!-- REKLAM MODALI -->
    <div id="adModal" class="modal hidden">
      <div class="modal-content">
        <div id="adStepMain">
          <button id="adCloseIcon" class="modal-close">âœ•</button>
          <h2 id="adTitle">Reklam Ä°zleyerek +1 Puan</h2>
          <p id="adText">
            Bir video reklam izle; izledikten sonra alttaki <b>"ReklamÄ± izledim"</b>
            butonuna bas.
          </p>
          <div class="modal-actions">
            <button id="adCancelBtn" class="pill-button">
              <span id="adCancelBtnText">VazgeÃ§</span>
            </button>
            <button id="adWatchedBtn" class="pill-button primary">
              <span id="adWatchedBtnText">ReklamÄ± izledim</span>
            </button>
          </div>
        </div>

        <div id="adStepConfirm" class="hidden">
          <h3 id="adConfirmTitle">Emin misin?</h3>
          <p id="adConfirmText">ReklamÄ± izlemekten vazgeÃ§mek Ã¼zeresin.</p>
          <div class="modal-actions">
            <button id="adContinueBtn" class="pill-button">
              <span id="adContinueBtnText">ReklamÄ± izlemeye devam et</span>
            </button>
            <button id="adConfirmCloseBtn" class="pill-button primary">
              <span id="adConfirmCloseBtnText">Evet, kapat</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PRO PLANI MODALI -->
    <div id="proModal" class="modal hidden">
      <div class="modal-content">
        <button id="proCloseBtn" class="modal-close">âœ•</button>
        <h2 id="proTitle">InspireApp PRO</h2>
        <p id="proPriceText"></p>
        <p id="proDesc">
          PRO plan; sÄ±nÄ±rsÄ±z kredi, reklamsÄ±z kullanÄ±m ve gelecekteki premium
          Ã¶zelliklere eriÅŸim saÄŸlar.
        </p>
        <div class="modal-actions">
          <button id="proPayBtn" class="pill-button primary">
            <span id="proPayBtnText">PROâ€™ya geÃ§</span>
          </button>
        </div>
      </div>
    </div>

    <!-- JS (TEK PARÃ‡A) -->
    <script>
      // =========================
      // === LOCAL STORAGE KEYS ===
      // =========================
      const STORAGE_KEY = "inspireapp_conversations_v1";
      const CREDITS_KEY = "inspireapp_credits_v1";
      const PLAN_KEY = "inspireapp_plan_v1";
      const EMAIL_KEY = "inspireapp_email_v1";
      const LANG_KEY = "inspireapp_lang_v1";

      const AD_COUNT_KEY = "inspireapp_daily_ad_count_v1";
      const AD_DATE_KEY = "inspireapp_daily_ad_date_v1";

      const MAX_FREE_CREDITS = 4;
      const DAILY_AD_LIMIT = 400;

      // =========================
      // === NETWORK SETTINGS  ===
      // =========================
      const API_TIMEOUT_MS = 15000;

      async function fetchWithTimeout(url, options = {}, timeoutMs = API_TIMEOUT_MS) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeoutMs);
        try {
          return await fetch(url, { ...options, signal: controller.signal, cache: "no-store" });
        } finally {
          clearTimeout(id);
        }
      }

      // =========================
      // === LANGUAGE TABLES    ===
      // =========================
      const LANG_NAMES = { tr: "Turkish", en: "English", ar: "Arabic", de: "German", es: "Spanish" };
      const LANG_REGION = { tr: "TR", en: "US", ar: "SA", de: "DE", es: "ES" };
      const LANG_LABELS = { tr: "TÃ¼rkÃ§e", en: "English", ar: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", de: "Deutsch", es: "EspaÃ±ol" };
      const LANG_SPEECH = { tr: "tr-TR", en: "en-US", ar: "ar-SA", de: "de-DE", es: "es-ES" };

      // I18N (Seninkini korudum, sadece 2 kÃ¼Ã§Ã¼k ek yaptÄ±m: adPlayingText + proRequiredText)
      const I18N = {
        tr: {
          topTitle: "INSPIREAPP",
          sidebarTitle: "Hesap & Sohbetler",
          sidebarUserTitle: "KullanÄ±cÄ±",
          sidebarEmailLabel: "E-posta",
          sidebarStatusLabel: "Durum",
          sidebarChatsTitle: "Sohbetler",
          sidebarPanelsTitle: "Paneller",
          changeEmailBtnText: "E-postayÄ± deÄŸiÅŸtir",
          newChatBtnText: "+ Yeni sohbet",
          btnPanelChatText: "Sohbet",
          btnPanelTrendsText: "Trend AkÄ±mÄ±",
          btnPanelSeriesText: "30 GÃ¼nlÃ¼k Seri",
          btnPanelHookText: "Hook LaboratuvarÄ±",
          btnPanelCopyText: "Trend Kopya Makinesi",
          btnPanelProText: "PRO AraÃ§larÄ±",
          helpToggle2Text: "â“ YardÄ±m",

          helpTitle: "Bilgi & Destek",
          helpAppTitle: "Uygulama",
          helpAppText1:
            "InspireApp, kÄ±sa video Ã¼reticileri iÃ§in yapay zekÃ¢ destekli profesyonel fikir oluÅŸturma + akÄ±m analiz + iÃ§erik planlama aracÄ±dÄ±r.",
          helpAppText2:
            "YouTube Shorts, TikTok, Instagram Reels iÃ§in Ã¶zel fikir, hook, baÅŸlÄ±k, trend kopyalama ve iÃ§erik akÄ±ÅŸÄ± Ã¼retir.",
          helpFreeTitle: "Ãœcretsiz Plan",
          helpFreeText: "GÃ¼nlÃ¼k 4 puan. Reklam izleyerek artÄ±rÄ±labilir.",
          helpProTitle: "PRO Plan",
          helpProText:
            "Fiyat bilgisi ve Ã¶deme, PRO'ya geÃ§ butonuna bastÄ±ÄŸÄ±nÄ±zda aÃ§Ä±lan ekranda gÃ¶sterilir (Google Play Ã¼zerinden satÄ±n alma).",
          helpSupportTitle: "Destek",
          helpSupportText: "E-posta: insprireappdestek@gmail.com",
          closeHelpBtnText: "Kapat",

          trendsTitle: "ğŸ”¥ Trendler (Bu Hafta)",
          refreshTrendsBtnText: "Trendleri Yenile",

          seriesTitle: "ğŸ—“ï¸ 30 GÃ¼nlÃ¼k Seri PlanÄ±",
          seriesDesc: "Bir konu gir, InspireApp sana 30 gÃ¼nlÃ¼k kÄ±sa video planÄ± Ã§Ä±karsÄ±n.",
          seriesPlaceholder: "Ã–rn: SaÄŸlÄ±klÄ± yemek, motivasyon videolarÄ±...",
          seriesGenerateText: "30 gÃ¼nlÃ¼k planÄ± oluÅŸtur",

          hookTitle: "âš¡ Hook LaboratuvarÄ±",
          hookDesc: "Konunu yaz; ilk 3 saniyede izleyiciyi Ã§eken gÃ¼Ã§lÃ¼ giriÅŸ cÃ¼mleleri (hook) Ã¼retelim.",
          hookPlaceholder: "Ã–rn: Ã–ÄŸrenciler iÃ§in verimli ders Ã§alÄ±ÅŸma",
          hookGenerateText: "Hook Ã¶nerilerini Ã¼ret",

          copyTitle: "ğŸ¬ Trend Kopya Makinesi",
          copyDesc: "BeÄŸendiÄŸin bir trend / video fikrini yaz; InspireApp bunu senin niÅŸine gÃ¶re yeniden yazar.",
          copyPlaceholder: "Ã–rn: Åu videoyu kendi marka tonuma uyarlamak istiyorum...",
          copyGenerateText: "Trend kopyasÄ±nÄ± oluÅŸtur",

          chatTitle: "ğŸ’¬ Sohbet",
          topicPlaceholder: "Konu (Ã¶rn: moda)",
          messagePlaceholder: "Mesaj yaz...",
          sendBtnText: "GÃ¶nder",
          watchAdBtnText: "Reklam izle +1 puan",
          loadingText: "YÃ¼kleniyor...",

          proPanelTitle: "â­ PRO AraÃ§larÄ±",
          proPanelDesc: "Bu bÃ¶lÃ¼mdeki araÃ§lar PRO kullanÄ±cÄ±lar iÃ§in tasarlandÄ±. Ãœcretsiz planda kÄ±sÄ±tlÄ±, PRO'da tam gÃ¼Ã§ aÃ§Ä±lÄ±r.",
          proTool1Title: "1) Rakip Video Analizi",
          proTool1Desc: "TikTok / Reels / Shorts linki veya aÃ§Ä±klamasÄ±nÄ± gir.",
          proTool3Title: "3) Kitle Ä°Ã§gÃ¶rÃ¼ Analizi",
          proTool3Desc: "Hedef kitleni tek cÃ¼mle ile anlat.",
          proTool5Title: "5) Sessiz Video Ä°Ã§erik Ãœreticisi",
          proTool5Desc: "YÃ¼zÃ¼nÃ¼ gÃ¶stermeden, ses kullanmadan iÃ§erik Ã¼retmek istiyorsan konunu yaz.",
          proCompetitorBtnText: "Rakip videoyu analiz et (PRO)",
          proAudienceBtnText: "Kitle iÃ§gÃ¶rÃ¼sÃ¼ Ã¼ret (PRO)",
          proSilentBtnText: "Sessiz iÃ§erik fikirleri Ã¼ret (PRO)",

          planFreeLabel: "Plan: Ãœcretsiz",
          planProLabel: "Plan: Pro (sÄ±nÄ±rsÄ±z puan)",
          creditsLabelFree: (credits) => `Kalan puan: ${credits}/${MAX_FREE_CREDITS}`,
          creditsLabelPro: "Kalan puan: SÄ±nÄ±rsÄ±z",

          onboardTitle: "INSPIREAPP",
          onboardLangTitle: "Dil seÃ§in",
          onboardLangSaveBtnText: "Devam",
          onboardEmailTitle: "E-posta adresiniz",
          onboardEmailPlaceholder: "ornek@mail.com",
          onboardEmailSaveBtnText: "Sohbete baÅŸla",

          adTitle: "Reklam",
          adText: "ReklamÄ± izledikten sonra <b>ReklamÄ± izledim</b> butonuna bas.",
          adCancelBtnText: "VazgeÃ§",
          adWatchedBtnText: "ReklamÄ± izledim",
          adConfirmTitle: "Emin misin?",
          adConfirmText: "ReklamÄ± izlemekten vazgeÃ§mek Ã¼zeresin.",
          adContinueBtnText: "ReklamÄ± izlemeye devam et",
          adConfirmCloseBtnText: "Evet, kapat",
          adDailyLimit: (limit) => `GÃ¼nlÃ¼k reklam limiti doldu. (Limit: ${limit})`,
          adPlayingText: "Reklam izleniyorâ€¦ Bitince sonuÃ§ gelecek.",

          proTitle: "InspireApp PRO",
          proDesc: "PRO plan; sÄ±nÄ±rsÄ±z kredi, reklamsÄ±z kullanÄ±m ve gelecekteki premium Ã¶zelliklere eriÅŸim saÄŸlar.",
          proPayBtnText: "PROâ€™ya geÃ§",
          proPriceTextTr: "InspireApp PRO â€“ aylÄ±k 299 TL (Google Play Ã¼zerinden Ã¼cretlendirilir).",
          proPriceTextEn: "InspireApp PRO â€“ monthly subscription via Google Play.",

          emailNotSavedAlert: "LÃ¼tfen geÃ§erli bir e-posta gir.",
          freeNoCreditsAlert: "Ãœcretsiz planda kredi bitti. Reklam izleyerek +1 alabilirsin.",
          proRequiredText: "Bu iÃ§erik PRO gerektirir. PROâ€™ya geÃ§erek aÃ§abilirsin.",
        },
        en: {
          topTitle: "INSPIREAPP",
          sidebarTitle: "Account & Chats",
          sidebarUserTitle: "User",
          sidebarEmailLabel: "Email",
          sidebarStatusLabel: "Status",
          sidebarChatsTitle: "Chats",
          sidebarPanelsTitle: "Panels",
          changeEmailBtnText: "Change email",
          newChatBtnText: "+ New chat",
          btnPanelChatText: "Chat",
          btnPanelTrendsText: "Trend Stream",
          btnPanelSeriesText: "30-Day Series",
          btnPanelHookText: "Hook Lab",
          btnPanelCopyText: "Trend Copy Machine",
          btnPanelProText: "PRO Tools",
          helpToggle2Text: "â“ Help",

          helpTitle: "Info & Support",
          helpAppTitle: "App",
          helpAppText1: "InspireApp is an AI-powered idea + trend + content planning assistant for short-form creators.",
          helpAppText2: "It generates ideas, hooks, titles, and trend-based flows for YouTube Shorts, TikTok and Instagram Reels.",
          helpFreeTitle: "Free Plan",
          helpFreeText: "4 credits per day. You can increase by watching ads.",
          helpProTitle: "PRO Plan",
          helpProText: "Price and billing details are shown when you tap the 'Go PRO' button (billing via Google Play).",
          helpSupportTitle: "Support",
          helpSupportText: "Email: insprireappdestek@gmail.com",
          closeHelpBtnText: "Close",

          trendsTitle: "ğŸ”¥ Trends (This Week)",
          refreshTrendsBtnText: "Refresh trends",

          seriesTitle: "ğŸ“… 30-Day Series Plan",
          seriesDesc: "Enter a topic and InspireApp will create a 30-day short video plan.",
          seriesPlaceholder: "Ex: Healthy meals, motivation videos...",
          seriesGenerateText: "Generate 30-day plan",

          hookTitle: "âš¡ Hook Lab",
          hookDesc: "Write your topic; we generate strong hook sentences for the first 3 seconds.",
          hookPlaceholder: "Ex: Efficient studying for students",
          hookGenerateText: "Generate hook ideas",

          copyTitle: "ğŸ¬ Trend Copy Machine",
          copyDesc: "Paste a trend / video idea; InspireApp rewrites it for your niche.",
          copyPlaceholder: "Ex: I want to adapt this video idea to my brand tone...",
          copyGenerateText: "Generate trend copy",

          chatTitle: "ğŸ’¬ Chat",
          topicPlaceholder: "Topic (e.g. fashion)",
          messagePlaceholder: "Type a message...",
          sendBtnText: "Send",
          watchAdBtnText: "Watch Ad +1 credit",
          loadingText: "Loading...",

          proPanelTitle: "â­ PRO Tools",
          proPanelDesc: "These tools are designed for PRO users. On free plan they are limited; PRO unlocks full power.",
          proTool1Title: "1) Competitor Video Analysis",
          proTool1Desc: "Paste a TikTok / Reels / Shorts link or description.",
          proTool3Title: "3) Audience Insight Analysis",
          proTool3Desc: "Describe your target audience in one sentence.",
          proTool5Title: "5) Silent Content Generator",
          proTool5Desc: "Faceless / silent content flows and ideas.",
          proCompetitorBtnText: "Analyze competitor video (PRO)",
          proAudienceBtnText: "Generate audience insights (PRO)",
          proSilentBtnText: "Generate silent content ideas (PRO)",

          planFreeLabel: "Plan: Free",
          planProLabel: "Plan: Pro (unlimited credits)",
          creditsLabelFree: (credits) => `Credits: ${credits}/${MAX_FREE_CREDITS}`,
          creditsLabelPro: "Credits: Unlimited",

          onboardTitle: "INSPIREAPP",
          onboardLangTitle: "Choose language",
          onboardLangSaveBtnText: "Continue",
          onboardEmailTitle: "Your email address",
          onboardEmailPlaceholder: "you@example.com",
          onboardEmailSaveBtnText: "Start chatting",

          adTitle: "Ad",
          adText: "Watch the ad and press <b>I watched</b>.",
          adCancelBtnText: "Cancel",
          adWatchedBtnText: "I watched",
          adConfirmTitle: "Are you sure?",
          adConfirmText: "You are about to cancel watching the ad.",
          adContinueBtnText: "Keep watching",
          adConfirmCloseBtnText: "Yes, close",
          adDailyLimit: (limit) => `Daily ad limit reached. (Limit: ${limit})`,
          adPlayingText: "Ad is playingâ€¦ Result will appear after it ends.",

          proTitle: "InspireApp PRO",
          proDesc: "PRO gives unlimited credits, no ads, and access to premium features.",
          proPayBtnText: "Go PRO",
          proPriceTextTr: "InspireApp PRO â€“ monthly subscription via Google Play.",
          proPriceTextEn: "InspireApp PRO â€“ monthly subscription via Google Play.",

          emailNotSavedAlert: "Please enter a valid email.",
          freeNoCreditsAlert: "You ran out of credits. Watch an ad to get +1.",
          proRequiredText: "This content requires PRO. Upgrade to unlock.",
        },
        ar: {}, de: {}, es: {}
      };

      const UI_TEXT = {
        tr: { send: "GÃ¶nder", ad: "Reklam izle +1 puan", placeholder: "Mesaj yaz veya konu gir..." },
        en: { send: "Send", ad: "Watch Ad +1 credit", placeholder: "Type a message or topic..." },
        ar: { send: "Ø¥Ø±Ø³Ø§Ù„", ad: "Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ +1 Ù†Ù‚Ø·Ø©", placeholder: "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ ÙÙƒØ±Ø©..." },
        de: { send: "Senden", ad: "Werbung ansehen +1 Punkt", placeholder: "Nachricht oder Thema eingeben..." },
        es: { send: "Enviar", ad: "Ver anuncio +1 crÃ©dito", placeholder: "Escribe un mensaje o tema..." },
      };

      // =========================
      // === STATE              ===
      // =========================
      const state = {
        conversations: [],
        currentId: null,
        plan: "free",
        credits: MAX_FREE_CREDITS,
        lang: "tr",
        email: "",
      };

      const $ = (id) => document.getElementById(id);

      function sanitizeEmail(raw) {
        const e = String(raw || "").trim();
        if (!e) return "";
        const low = e.toLowerCase();
        if (low === "null" || low === "undefined" || low === "none") return "";
        return e;
      }

      function getEmailSafe() {
        const fromState = sanitizeEmail(state.email);
        const fromStore = sanitizeEmail(localStorage.getItem(EMAIL_KEY));
        return (fromState || fromStore || "").trim();
      }

      // ===== speed: debounce save conversations
      let _saveTimer = null;
      function saveConversationsDebounced() {
        if (_saveTimer) clearTimeout(_saveTimer);
        _saveTimer = setTimeout(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.conversations));
          } catch {}
          _saveTimer = null;
        }, 150);
      }

      function saveCredits() { try { localStorage.setItem(CREDITS_KEY, String(state.credits)); } catch {} }
      function savePlan() { try { localStorage.setItem(PLAN_KEY, state.plan); } catch {} }
      function saveLang() { try { localStorage.setItem(LANG_KEY, state.lang); } catch {} }
      function saveEmail() {
        try {
          const e = sanitizeEmail(state.email);
          if (e) localStorage.setItem(EMAIL_KEY, e);
          else localStorage.removeItem(EMAIL_KEY);
        } catch {}
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) state.conversations = JSON.parse(raw);
        } catch {
          state.conversations = [];
        }
        if (!state.conversations.length) {
          state.conversations.push({ id: Date.now().toString(), title: "Yeni sohbet", messages: [], createdAt: Date.now() });
        }
        state.currentId = state.conversations[0].id;

        const p = localStorage.getItem(PLAN_KEY);
        if (p === "pro" || p === "free") state.plan = p;

        const cStr = localStorage.getItem(CREDITS_KEY);
        const c = parseInt(cStr || "", 10);
        state.credits = Number.isNaN(c) ? MAX_FREE_CREDITS : c;

        const l = localStorage.getItem(LANG_KEY);
        if (l && LANG_NAMES[l]) state.lang = l;

        const e = sanitizeEmail(localStorage.getItem(EMAIL_KEY));
        if (e) state.email = e;
      }

      function currentConv() { return state.conversations.find((c) => c.id === state.currentId); }

      function buildTitleFromText(text) {
        if (!text) return "Sohbet";
        let line = text.split("\n")[0];
        line = line.split(/[.!?]/)[0].trim();
        if (!line) line = text.trim();
        if (line.length > 40) line = line.slice(0, 40) + "â€¦";
        return line || "Sohbet";
      }

      // =========================
      // === UI TRANSLATION     ===
      // =========================
      function applyUITextForLang(code) {
        const t = I18N[code] || I18N.tr;

        document.documentElement.lang = code || "tr";
        document.documentElement.dir = code === "ar" ? "rtl" : "ltr";

        const setText = (id, value) => { const el = $(id); if (el && value !== undefined) el.textContent = value; };
        const setHTML = (id, value) => { const el = $(id); if (el && value !== undefined) el.innerHTML = value; };
        const setPlaceholder = (id, value) => { const el = $(id); if (el && value !== undefined) el.placeholder = value; };

        setText("topTitle", t.topTitle);

        setText("sidebarTitle", t.sidebarTitle);
        setText("sidebarUserTitle", t.sidebarUserTitle);
        setText("sidebarEmailLabel", t.sidebarEmailLabel);
        setText("sidebarStatusLabel", t.sidebarStatusLabel);
        setText("sidebarChatsTitle", t.sidebarChatsTitle);
        setText("sidebarPanelsTitle", t.sidebarPanelsTitle);
        setText("changeEmailBtnText", t.changeEmailBtnText);
        setText("newChatBtnText", t.newChatBtnText);
        setText("btnPanelChatText", t.btnPanelChatText);
        setText("btnPanelTrendsText", t.btnPanelTrendsText);
        setText("btnPanelSeriesText", t.btnPanelSeriesText);
        setText("btnPanelHookText", t.btnPanelHookText);
        setText("btnPanelCopyText", t.btnPanelCopyText);
        setText("btnPanelProText", t.btnPanelProText);
        setText("helpToggle2Text", t.helpToggle2Text);

        setText("helpTitle", t.helpTitle);
        setText("helpAppTitle", t.helpAppTitle);
        setHTML("helpAppText1", t.helpAppText1);
        setHTML("helpAppText2", t.helpAppText2);
        setText("helpFreeTitle", t.helpFreeTitle);
        setText("helpFreeText", t.helpFreeText);
        setText("helpProTitle", t.helpProTitle);
        setHTML("helpProText", t.helpProText);
        setText("helpSupportTitle", t.helpSupportTitle);
        setText("helpSupportText", t.helpSupportText);
        setText("closeHelpBtnText", t.closeHelpBtnText);

        setText("trendsTitle", t.trendsTitle);
        setText("refreshTrendsBtnText", t.refreshTrendsBtnText);

        setText("seriesTitle", t.seriesTitle);
        setText("seriesDesc", t.seriesDesc);
        setPlaceholder("seriesTopic", t.seriesPlaceholder);
        setText("seriesGenerateText", t.seriesGenerateText);

        setText("hookTitle", t.hookTitle);
        setText("hookDesc", t.hookDesc);
        setPlaceholder("hookTopic", t.hookPlaceholder);
        setText("hookGenerateText", t.hookGenerateText);

        setText("copyTitle", t.copyTitle);
        setText("copyDesc", t.copyDesc);
        setPlaceholder("copyTopic", t.copyPlaceholder);
        setText("copyGenerateText", t.copyGenerateText);

        setText("chatTitle", t.chatTitle);
        setPlaceholder("topicInput", t.topicPlaceholder);
        setPlaceholder("messageInput", t.messagePlaceholder);
        setText("sendBtnText", t.sendBtnText);
        setText("watchAdBtnText", t.watchAdBtnText);
        const loadingEl = $("loading");
        if (loadingEl) loadingEl.textContent = t.loadingText;

        setText("onboardTitle", t.onboardTitle);
        setText("onboardLangTitle", t.onboardLangTitle);
        setText("onboardLangSaveBtnText", t.onboardLangSaveBtnText);
        setText("onboardEmailTitle", t.onboardEmailTitle);
        setPlaceholder("onboardEmailInput", t.onboardEmailPlaceholder);
        setText("onboardEmailSaveBtnText", t.onboardEmailSaveBtnText);

        setText("adTitle", t.adTitle);
        setHTML("adText", t.adText);
        setText("adCancelBtnText", t.adCancelBtnText);
        setText("adWatchedBtnText", t.adWatchedBtnText);
        setText("adConfirmTitle", t.adConfirmTitle);
        setText("adConfirmText", t.adConfirmText);
        setText("adContinueBtnText", t.adContinueBtnText);
        setText("adConfirmCloseBtnText", t.adConfirmCloseBtnText);

        setText("proTitle", t.proTitle);
        setText("proDesc", t.proDesc);
        setText("proPayBtnText", t.proPayBtnText);

        setText("proPanelTitle", t.proPanelTitle);
        setText("proPanelDesc", t.proPanelDesc);
        setText("proTool1Title", t.proTool1Title);
        setText("proTool1Desc", t.proTool1Desc);
        setText("proTool3Title", t.proTool3Title);
        setText("proTool3Desc", t.proTool3Desc);
        setText("proTool5Title", t.proTool5Title);
        setText("proTool5Desc", t.proTool5Desc);
        setText("proCompetitorBtnText", t.proCompetitorBtnText);
        setText("proAudienceBtnText", t.proAudienceBtnText);
        setText("proSilentBtnText", t.proSilentBtnText);

        setText("proMenuTool1", t.proTool1Title);
        setText("proMenuTool3", t.proTool3Title);
        setText("proMenuTool5", t.proTool5Title);

        updatePlanAndCreditsUI();
        updateAccountEmailUI();
      }

      function applySmallUIText(code) {
        const t = UI_TEXT[code] || UI_TEXT.en;
        const sendBtn = $("sendBtnText");
        const watchAdBtn = $("watchAdBtnText");
        const messageInput = $("messageInput");
        if (sendBtn) sendBtn.textContent = t.send;
        if (watchAdBtn) watchAdBtn.textContent = t.ad;
        if (messageInput && !messageInput.value) messageInput.placeholder = t.placeholder;
      }

      function fillLangSelect(selectEl) {
        if (!selectEl) return;
        selectEl.innerHTML = "";
        Object.keys(LANG_NAMES).forEach((code) => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = LANG_LABELS[code] || code;
          selectEl.appendChild(opt);
        });
        selectEl.value = state.lang;
      }

      // =========================
      // === RENDER CHAT LIST   ===
      // =========================
      function renderConversationList() {
        const listEl = $("conversationList");
        if (!listEl) return;
        listEl.innerHTML = "";

        function handleDelete(convId) {
          const confirmText =
            state.lang === "tr" ? "Bu sohbeti silmek istiyor musun?" :
            state.lang === "ar" ? "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŸ" :
            state.lang === "de" ? "MÃ¶chtest du diesen Chat lÃ¶schen?" :
            state.lang === "es" ? "Â¿Quieres eliminar este chat?" :
            "Do you want to delete this chat?";
          if (!confirm(confirmText)) return;

          state.conversations = state.conversations.filter((c) => c.id !== convId);
          if (!state.conversations.length) {
            state.conversations.push({
              id: Date.now().toString(),
              title: state.lang === "tr" ? "Yeni sohbet" : "New chat",
              messages: [],
              createdAt: Date.now(),
            });
          }
          state.currentId = state.conversations[0].id;
          saveConversationsDebounced();
          renderConversationList();
          renderMessages();
        }

        state.conversations
          .slice()
          .sort((a, b) => b.createdAt - a.createdAt)
          .forEach((conv) => {
            const item = document.createElement("div");
            item.className = "conversation-item" + (conv.id === state.currentId ? " active" : "");
            item.textContent = conv.title || "Sohbet";

            item.addEventListener("click", () => {
              state.currentId = conv.id;
              renderConversationList();
              renderMessages();
            });

            item.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              if (!("ontouchstart" in window)) handleDelete(conv.id);
            });

            let pressTimer = null;
            item.addEventListener("touchstart", () => {
              pressTimer = setTimeout(() => handleDelete(conv.id), 600);
            }, { passive: true });

            const cancelPress = () => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } };
            ["touchend", "touchmove", "touchcancel"].forEach((ev) => item.addEventListener(ev, cancelPress));

            listEl.appendChild(item);
          });
      }

      function renderMessages() {
        const container = $("chatMessages");
        if (!container) return;
        const conv = currentConv();
        container.innerHTML = "";

        (conv?.messages || []).forEach((m) => {
          const row = document.createElement("div");
          row.className = "message-row " + m.role;

          const bubble = document.createElement("div");
          bubble.className = "bubble";

          const textEl = document.createElement("pre");
          textEl.className = "bubble-text";
          textEl.textContent = m.text;

          bubble.appendChild(textEl);
          row.appendChild(bubble);
          container.appendChild(row);
        });

        container.scrollTop = container.scrollHeight;
      }

      function addMessage(role, text) {
        const conv = currentConv();
        conv.messages.push({ role, text });

        if (!conv.title || conv.title === "Yeni sohbet" || conv.title === "New chat") {
          const firstUserMsg = conv.messages.find((m) => m.role === "user");
          if (firstUserMsg?.text) conv.title = buildTitleFromText(firstUserMsg.text);
        }

        saveConversationsDebounced();
        renderConversationList();
        renderMessages();
      }

      // =========================
      // === PLAN / CREDITS UI  ===
      // =========================
      function updatePlanAndCreditsUI() {
        const t = I18N[state.lang] || I18N.tr;
        const planLabel = $("planLabel");
        const creditsLabel = $("creditsLabel");
        const watchAdBtn = $("watchAdBtn");
        const planStatus = $("planStatus");
        const subscribeBlock = $("subscribeBlock");

        if (planLabel) planLabel.textContent = state.plan === "pro" ? t.planProLabel : t.planFreeLabel;
        if (creditsLabel) {
          creditsLabel.textContent =
            state.plan === "pro" ? t.creditsLabelPro :
            (t.creditsLabelFree ? t.creditsLabelFree(state.credits) : "");
        }
        if (watchAdBtn) watchAdBtn.classList.toggle("hidden", state.plan !== "free");
        if (planStatus) planStatus.textContent = state.plan === "pro" ? t.planProLabel : t.planFreeLabel;
        if (subscribeBlock) subscribeBlock.classList.toggle("hidden", state.plan === "pro");
      }

      function updateAccountEmailUI() {
        const el = $("accountEmail");
        if (!el) return;
        const notSaved =
          state.lang === "tr" ? "KayÄ±tlÄ± deÄŸil" :
          state.lang === "ar" ? "ØºÙŠØ± Ù…Ø­ÙÙˆØ¸" :
          state.lang === "de" ? "Nicht gespeichert" :
          state.lang === "es" ? "No guardado" : "Not set";
        el.textContent = getEmailSafe() || notSaved;
      }

      function setPlan(next) {
        if (next !== "pro" && next !== "free") return;
        state.plan = next;
        savePlan();
        updatePlanAndCreditsUI();
      }

      // =========================
      // === PANEL SWITCHING     ===
      // =========================
      let currentPanel = "chat";
      let previousPanel = null;

      function showPanel(name) {
        if (!name) return;
        if (name === currentPanel) return;
        previousPanel = currentPanel;
        currentPanel = name;

        document.querySelectorAll("main .panel").forEach((sec) => sec.classList.add("hidden"));
        const active = $("panel-" + name);
        if (active) active.classList.remove("hidden");
      }

      // =========================
      // === MODALS             ===
      // =========================
      function openProModal() {
        const modalBackdrop = $("modalBackdrop");
        const proModal = $("proModal");
        const proPriceText = $("proPriceText");
        if (!modalBackdrop || !proModal) return;
        const t = I18N[state.lang] || I18N.tr;
        const isTr = state.lang === "tr";
        if (proPriceText) proPriceText.textContent = isTr ? t.proPriceTextTr : t.proPriceTextEn;
        modalBackdrop.classList.remove("hidden");
        proModal.classList.remove("hidden");
      }

      function closeProModal() {
        const modalBackdrop = $("modalBackdrop");
        const proModal = $("proModal");
        if (proModal) proModal.classList.add("hidden");
        if (modalBackdrop) modalBackdrop.classList.add("hidden");
      }

      function openAdModal() {
        const modalBackdrop = $("modalBackdrop");
        const adModal = $("adModal");
        const adStepMain = $("adStepMain");
        const adStepConfirm = $("adStepConfirm");
        if (adStepMain) adStepMain.classList.remove("hidden");
        if (adStepConfirm) adStepConfirm.classList.add("hidden");
        if (modalBackdrop) modalBackdrop.classList.remove("hidden");
        if (adModal) adModal.classList.remove("hidden");
      }

      function closeAdModal() {
        const modalBackdrop = $("modalBackdrop");
        const adModal = $("adModal");
        if (adModal) adModal.classList.add("hidden");
        if (modalBackdrop) modalBackdrop.classList.add("hidden");
        __pendingRewardAction = null;
        __rewardPurpose = null;
      }

      // =========================
      // === REWARDED AD GATE    ===
      // =========================
      let __pendingRewardAction = null; // function
      let __rewardPurpose = null; // "credit" | "generate"

      function startRewardAd(purpose, actionFn) {
        __rewardPurpose = purpose;
        __pendingRewardAction = typeof actionFn === "function" ? actionFn : null;

        // Android real ad
        if (window.AndroidAds && typeof window.AndroidAds.showRewardedAd === "function") {
          window.AndroidAds.showRewardedAd();
          return;
        }
        // Web demo
        openAdModal();
      }

      function grantReward() {
        // 1) generate => kredi verme, sadece iÅŸi Ã§alÄ±ÅŸtÄ±r
        if (__rewardPurpose === "generate" && typeof __pendingRewardAction === "function") {
          const fn = __pendingRewardAction;
          __pendingRewardAction = null;
          __rewardPurpose = null;
          try { fn(); } catch {}
          return;
        }

        // 2) credit => sadece sohbet kredisi +1
        if (__rewardPurpose === "credit") {
          __pendingRewardAction = null;
          __rewardPurpose = null;

          if (state.plan !== "free") return;

          const t = I18N[state.lang] || I18N.tr;
          const today = new Date().toISOString().slice(0, 10);
          const storedDate = localStorage.getItem(AD_DATE_KEY);
          let storedCount = parseInt(localStorage.getItem(AD_COUNT_KEY) || "0", 10);

          if (storedDate !== today) storedCount = 0;
          if (storedCount >= DAILY_AD_LIMIT) {
            alert(t.adDailyLimit ? t.adDailyLimit(DAILY_AD_LIMIT) : "");
            return;
          }

          storedCount += 1;
          localStorage.setItem(AD_DATE_KEY, today);
          localStorage.setItem(AD_COUNT_KEY, String(storedCount));

          state.credits += 1;
          saveCredits();
          updatePlanAndCreditsUI();
        }
      }

      function handleRewardedAdFinished() {
        closeAdModal(); // hem modal hem backdrop kapatÄ±r
        grantReward();
      }

      // Android callbacks
      window.__onRewardedAdCompletedFromAndroid = function () { handleRewardedAdFinished(); };
      window.__onRealAdReward = function () { handleRewardedAdFinished(); };

      // Android PRO activation
      window.__setProPlanFromAndroid = function () {
        setPlan("pro");
        alert("ğŸ‰ PRO Ã¼yelik Google Play Ã¼zerinden aktif edildi!");
      };

      // =========================
      // === API HELPERS         ===
      // =========================
      function isProRequiredLike(x) {
        const s = typeof x === "string" ? x : JSON.stringify(x || {});
        return /PRO_REQUIRED|pro_required|ONLY_PRO|PRO ONLY|PRO_ONLY/i.test(s);
      }

      async function callSimpleAPI(route, payload, { useEmailHeader = false } = {}) {
        const emailSafe = getEmailSafe();
        const headers = { "Content-Type": "application/json" };
        if (useEmailHeader && emailSafe) headers["x-user-email"] = emailSafe;

        try {
          const res = await fetchWithTimeout(`/api/${route}`, {
            method: "POST",
            headers,
            body: JSON.stringify(payload || {}),
          });

          const text = await res.text();
          let json = null;
          try { json = JSON.parse(text); } catch {}

          // PRO required handling
          if (res.status === 403 || isProRequiredLike(json || text)) {
            openProModal();
            const t = I18N[state.lang] || I18N.tr;
            return t.proRequiredText || "PRO gerekiyor.";
          }

          if (json?.ok === true && route && String(route).startsWith("pro-")) {
            // backend PRO ok dÃ¶ndÃ¼rÃ¼yorsa UI'Ä± pro yap
            setPlan("pro");
          }

          return json?.message || json?.result || json?.answer || json?.content || text || "Sunucudan cevap alÄ±namadÄ±.";
        } catch {
          return "Sunucuya baÄŸlanÄ±rken bir hata oluÅŸtu.";
        }
      }

      async function callIdeasAPI(prompt, platform, langCode) {
        const langName = LANG_NAMES[langCode] || "Turkish";
        try {
          const res = await fetchWithTimeout("/api/ideas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, platform, lang: langName }),
          });
          const text = await res.text();
          try {
            const data = JSON.parse(text);
            return data?.message || data?.result || text || "API yanÄ±tÄ± boÅŸ.";
          } catch {
            return text || "API yanÄ±tÄ± boÅŸ.";
          }
        } catch {
          return "Sunucuya baÄŸlanÄ±rken bir hata oluÅŸtu.";
        }
      }

      async function loadTrends() {
        const list = $("trendsList");
        if (!list) return;
        const region = (LANG_REGION[state.lang] || "US").toUpperCase();
        list.innerHTML = "<li>YÃ¼kleniyor...</li>";
        try {
          const res = await fetchWithTimeout(`/api/trends?region=${region}`, { method: "GET" });
          const data = await res.json().catch(() => null);

          if (!res.ok) {
            list.innerHTML = "<li>Trendler alÄ±nÄ±rken hata: " + ((data && data.message) || "") + "</li>";
            return;
          }

          if (!data?.items?.length) {
            list.innerHTML = "<li>Bu hafta trend bulunamadÄ±.</li>";
            return;
          }

          list.innerHTML = "";
          data.items.forEach((item) => {
            const li = document.createElement("li");
            li.className = "trends-item";
            const a = document.createElement("a");
            a.href = item.url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = item.title;
            li.appendChild(a);
            list.appendChild(li);
          });
        } catch {
          list.innerHTML = "<li>Trendler alÄ±nÄ±rken beklenmeyen bir hata oluÅŸtu.</li>";
        }
      }

      // =========================
      // === BACK HANDLER (Android/History) ===
      // =========================
      window.__inspireHandleBack = function () {
        // onboarding
        const onboarding = $("onboardingOverlay");
        if (onboarding && !onboarding.classList.contains("hidden")) {
          onboarding.classList.add("hidden");
          return true;
        }

        // pro modal
        const proModal = $("proModal");
        if (proModal && !proModal.classList.contains("hidden")) { closeProModal(); return true; }

        // ad modal
        const adModal = $("adModal");
        if (adModal && !adModal.classList.contains("hidden")) { closeAdModal(); return true; }

        // help
        const helpPanel = $("helpPanel");
        if (helpPanel && !helpPanel.classList.contains("hidden")) { helpPanel.classList.add("hidden"); return true; }

        // sidebar
        const sidebar = $("sidebar");
        if (sidebar && !sidebar.classList.contains("hidden")) { sidebar.classList.add("hidden"); return true; }

        // pro panel tool close logic
        const proPanel = $("panel-pro");
        if (proPanel && !proPanel.classList.contains("hidden")) {
          if (window.__inspirePro_isToolOpen && window.__inspirePro_isToolOpen()) {
            window.__inspirePro_closeTool && window.__inspirePro_closeTool();
            return true;
          }
          showPanel("chat");
          return true;
        }

        // other panels -> chat
        const other = ["trends", "series", "hook", "copy"];
        for (const name of other) {
          const el = $("panel-" + name);
          if (el && !el.classList.contains("hidden")) { showPanel("chat"); return true; }
        }

        // if not chat -> go back to previous
        if (currentPanel && currentPanel !== "chat") { showPanel(previousPanel || "chat"); return true; }

        return false;
      };

      // =========================
      // === DOM READY          ===
      // =========================
      document.addEventListener("DOMContentLoaded", () => {
        loadState();

        const sidebar = $("sidebar");
        const helpPanel = $("helpPanel");

        const menuToggle = $("menuToggle");
        const helpToggle = $("helpToggle");
        const helpToggle2 = $("helpToggle2");
        const closeHelpBtn = $("closeHelpBtn");

        const chatForm = $("chatForm");
        const topicInput = $("topicInput");
        const platformSelect = $("platformSelect");
        const langSelect = $("langSelect");
        const messageInput = $("messageInput");
        const loadingEl = $("loading");

        const newChatBtn = $("newChatBtn");
        const watchAdBtn = $("watchAdBtn");
        const subscribeBtn = $("subscribeBtn");
        const changeEmailBtn = $("changeEmailBtn");

        const voiceBtn = $("voiceBtn");
        const cameraBtn = $("cameraBtn");
        const cameraFileInput = $("cameraFileInput");

        const refreshTrendsBtn = $("refreshTrendsBtn");
        const seriesGenerate = $("seriesGenerate");
        const seriesTopic = $("seriesTopic");
        const seriesResult = $("seriesResult");

        const hookGenerate = $("hookGenerate");
        const hookTopic = $("hookTopic");
        const hookResult = $("hookResult");

        const copyGenerate = $("copyGenerate");
        const copyTopic = $("copyTopic");
        const copyResult = $("copyResult");

        const proCompetitorInput = $("proCompetitorInput");
        const proCompetitorBtn = $("proCompetitorBtn");
        const proCompetitorResult = $("proCompetitorResult");

        const proAudienceInput = $("proAudienceInput");
        const proAudienceBtn = $("proAudienceBtn");
        const proAudienceResult = $("proAudienceResult");

        const proSilentInput = $("proSilentInput");
        const proSilentBtn = $("proSilentBtn");
        const proSilentResult = $("proSilentResult");

        const modalBackdrop = $("modalBackdrop");
        const adStepMain = $("adStepMain");
        const adStepConfirm = $("adStepConfirm");
        const adWatchedBtn = $("adWatchedBtn");
        const adCancelBtn = $("adCancelBtn");
        const adCloseIcon = $("adCloseIcon");
        const adContinueBtn = $("adContinueBtn");
        const adConfirmCloseBtn = $("adConfirmCloseBtn");

        const proCloseBtn = $("proCloseBtn");
        const proPayBtn = $("proPayBtn");

        const onboardingOverlay = $("onboardingOverlay");
        const onboardStepLang = $("onboardStepLang");
        const onboardStepEmail = $("onboardStepEmail");
        const onboardLangSelect = $("onboardLangSelect");
        const onboardLangSaveBtn = $("onboardLangSaveBtn");
        const onboardEmailInput = $("onboardEmailInput");
        const onboardPasswordInput = $("onboardPasswordInput");
        const onboardEmailSaveBtn = $("onboardEmailSaveBtn");

        // PRO mini pages
        const proToolLinks = document.querySelectorAll(".pro-tool-link");
        const proToolPages = document.querySelectorAll(".pro-tool-page");

        function openProTool(name) {
          proToolPages.forEach((page) => page.classList.toggle("active", page.dataset.proPage === name));
          proToolLinks.forEach((btn) => btn.classList.toggle("active", btn.dataset.proTool === name));
        }

        proToolLinks.forEach((btn) => {
          btn.addEventListener("click", () => {
            const name = btn.dataset.proTool;
            if (!name) return;
            openProTool(name);
          });
        });

        window.__inspirePro_isToolOpen = function () {
          return Array.from(proToolPages).some((p) => p.classList.contains("active"));
        };
        window.__inspirePro_closeTool = function () {
          proToolPages.forEach((p) => p.classList.remove("active"));
          proToolLinks.forEach((b) => b.classList.remove("active"));
        };

        // Fill selects
        fillLangSelect(langSelect);
        fillLangSelect(onboardLangSelect);

        // Render
        renderConversationList();
        renderMessages();
        applyUITextForLang(state.lang);
        applySmallUIText(state.lang);
        updatePlanAndCreditsUI();
        updateAccountEmailUI();
        loadTrends();

        // Onboarding logic: lang -> email
        function showOnboardingIfNeeded() {
          if (!onboardingOverlay || !onboardStepLang || !onboardStepEmail) return;
          const hasLang = !!localStorage.getItem(LANG_KEY);
          const hasEmail = !!sanitizeEmail(localStorage.getItem(EMAIL_KEY));
          if (hasLang && hasEmail) {
            onboardingOverlay.classList.add("hidden");
            return;
          }
          onboardingOverlay.classList.remove("hidden");
          if (!hasLang) {
            onboardStepLang.classList.remove("hidden");
            onboardStepEmail.classList.add("hidden");
          } else {
            onboardStepLang.classList.add("hidden");
            onboardStepEmail.classList.remove("hidden");
            setTimeout(() => { try { onboardEmailInput && onboardEmailInput.focus(); } catch {} }, 50);
          }
        }
        showOnboardingIfNeeded();

        // Sidebar open/close
        if (menuToggle && sidebar) menuToggle.addEventListener("click", () => sidebar.classList.toggle("hidden"));

        // swipe close
        let swipeStartX = null;
        document.addEventListener("touchstart", (e) => {
          const sidebarOpen = sidebar && !sidebar.classList.contains("hidden");
          const helpOpen = helpPanel && !helpPanel.classList.contains("hidden");
          if (!sidebarOpen && !helpOpen) return;
          swipeStartX = e.touches?.[0]?.clientX ?? null;
        }, { passive: true });

        document.addEventListener("touchend", (e) => {
          if (swipeStartX === null) return;
          const endX = e.changedTouches?.[0]?.clientX ?? swipeStartX;
          const diffX = endX - swipeStartX;
          if (Math.abs(diffX) > 60) {
            if (sidebar && !sidebar.classList.contains("hidden")) sidebar.classList.add("hidden");
            if (helpPanel && !helpPanel.classList.contains("hidden")) helpPanel.classList.add("hidden");
          }
          swipeStartX = null;
        }, { passive: true });

        // Help
        const openHelp = () => helpPanel && helpPanel.classList.remove("hidden");
        const closeHelp = () => helpPanel && helpPanel.classList.add("hidden");
        if (helpToggle) helpToggle.addEventListener("click", openHelp);
        if (helpToggle2) helpToggle2.addEventListener("click", openHelp);
        if (closeHelpBtn) closeHelpBtn.addEventListener("click", closeHelp);

        // New chat
        if (newChatBtn) {
          newChatBtn.addEventListener("click", () => {
            const conv = { id: Date.now().toString(), title: state.lang === "tr" ? "Yeni sohbet" : "New chat", messages: [], createdAt: Date.now() };
            state.conversations.unshift(conv);
            state.currentId = conv.id;
            saveConversationsDebounced();
            renderConversationList();
            renderMessages();
          });
        }

        // Panel switching
        document.querySelectorAll(".side-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.dataset.panel;
            showPanel(target);
            if (sidebar) sidebar.classList.add("hidden");
            if (target === "pro") window.__inspirePro_closeTool && window.__inspirePro_closeTool();
          });
        });

        // Backdrop click
        if (modalBackdrop) {
          modalBackdrop.addEventListener("click", (e) => {
            if (e.target !== modalBackdrop) return;
            closeAdModal();
            closeProModal();
          });
        }

        // Ad modal controls
        if (adCancelBtn) adCancelBtn.addEventListener("click", closeAdModal);

        if (adWatchedBtn) adWatchedBtn.addEventListener("click", handleRewardedAdFinished);

        if (adCloseIcon) adCloseIcon.addEventListener("click", () => {
          if (adStepMain) adStepMain.classList.add("hidden");
          if (adStepConfirm) adStepConfirm.classList.remove("hidden");
        });

        if (adContinueBtn) adContinueBtn.addEventListener("click", () => {
          if (adStepConfirm) adStepConfirm.classList.add("hidden");
          if (adStepMain) adStepMain.classList.remove("hidden");
        });

        if (adConfirmCloseBtn) adConfirmCloseBtn.addEventListener("click", closeAdModal);

        // Pro modal controls
        if (proCloseBtn) proCloseBtn.addEventListener("click", closeProModal);

        if (subscribeBtn) subscribeBtn.addEventListener("click", () => {
          if (state.plan === "pro") return;
          openProModal();
        });

        if (proPayBtn) proPayBtn.addEventListener("click", () => {
          const isTr = state.lang === "tr";
          if (window.AndroidBilling && window.AndroidBilling.startPurchase) {
            const sku = isTr ? "pro_monthly_tr" : "pro_monthly_intl";
            window.AndroidBilling.startPurchase(sku);
          } else {
            alert(isTr
              ? "Bu web sÃ¼rÃ¼mÃ¼nde gerÃ§ek Ã¶deme yok. Android buildâ€™de Google Play satÄ±n alma aÃ§Ä±lacak."
              : "Billing is not enabled in web preview. Use Android build.");
          }
        });

        // WatchAd (+1 credit) button
        if (watchAdBtn) {
          watchAdBtn.addEventListener("click", () => {
            if (state.plan !== "free") return;
            startRewardAd("credit");
          });
        }

        // Language change
        if (langSelect) {
          langSelect.addEventListener("change", () => {
            const code = langSelect.value;
            if (!LANG_NAMES[code]) return;
            state.lang = code;
            saveLang();
            applyUITextForLang(code);
            applySmallUIText(code);
            loadTrends();
          });
        }

        // Onboarding language step
        if (onboardLangSaveBtn && onboardLangSelect) {
          onboardLangSaveBtn.addEventListener("click", () => {
            const code = onboardLangSelect.value || "tr";
            state.lang = code;
            saveLang();
            if (langSelect) langSelect.value = code;

            applyUITextForLang(code);
            applySmallUIText(code);
            loadTrends();

            if (onboardStepLang) onboardStepLang.classList.add("hidden");
            if (onboardStepEmail) onboardStepEmail.classList.remove("hidden");
            setTimeout(() => { try { onboardEmailInput && onboardEmailInput.focus(); } catch {} }, 50);
          });
        }

        // Onboarding email+password step (register/login)
        if (onboardEmailSaveBtn && onboardEmailInput && onboardPasswordInput) {
          onboardEmailSaveBtn.addEventListener("click", async () => {
            const t = I18N[state.lang] || I18N.tr;
            const email = sanitizeEmail(onboardEmailInput.value).toLowerCase();
            const password = String(onboardPasswordInput.value || "").trim();

            if (!email || !password) {
              alert(state.lang === "tr" ? "LÃ¼tfen e-posta ve ÅŸifre girin." : "Please enter email and password.");
              return;
            }

            state.email = email;
            saveEmail();
            updateAccountEmailUI();

            try {
              const res = await fetchWithTimeout("/api/register-user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-user-email": email },
                body: JSON.stringify({ email, password, plan: state.plan, credits: state.credits, lang: state.lang }),
              });

              const data = await res.json().catch(() => null);

              if (res.status === 401 && (data?.code === "INVALID_PASSWORD" || data?.message === "INVALID_PASSWORD")) {
                alert(state.lang === "tr" ? "Åifre yanlÄ±ÅŸ. LÃ¼tfen tekrar deneyin." : "Wrong password. Please try again.");
                return;
              }

              if (!res.ok || !data) throw new Error(data?.error || data?.message || "Sunucu hatasÄ±");

              // server can override plan/credits/lang
              if (data.user?.plan) { state.plan = data.user.plan; savePlan(); }
              if (typeof data.user?.credits !== "undefined") { state.credits = data.user.credits; saveCredits(); }
              if (data.user?.lang && LANG_NAMES[data.user.lang]) { state.lang = data.user.lang; saveLang(); if (langSelect) langSelect.value = state.lang; }

              updatePlanAndCreditsUI();
              applyUITextForLang(state.lang);

              if (onboardingOverlay) onboardingOverlay.classList.add("hidden");

              if (data.status === "login") alert(state.lang === "tr" ? "GiriÅŸ baÅŸarÄ±lÄ±. ğŸ‘Œ" : "Login successful. ğŸ‘Œ");
              else if (data.status === "registered") alert(state.lang === "tr" ? "Hesap oluÅŸturuldu ve giriÅŸ yapÄ±ldÄ±. ğŸ‰" : "Account created and logged in. ğŸ‰");
            } catch (e) {
              alert((state.lang === "tr" ? "GiriÅŸ/kayÄ±t hatasÄ±: " : "Login/register error: ") + (e.message || ""));
            }
          });
        }

        if (changeEmailBtn) {
          changeEmailBtn.addEventListener("click", () => {
            if (!onboardingOverlay) return;
            if (onboardStepLang) onboardStepLang.classList.add("hidden");
            if (onboardStepEmail) onboardStepEmail.classList.remove("hidden");
            onboardingOverlay.classList.remove("hidden");
            setTimeout(() => { try { onboardEmailInput && onboardEmailInput.focus(); } catch {} }, 50);
          });
        }

        // Voice
        let recognition = null;
        if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
          const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRec();
          recognition.lang = LANG_SPEECH[state.lang] || "en-US";
          recognition.interimResults = false;
        }

        if (voiceBtn) {
          voiceBtn.addEventListener("click", () => {
            if (!recognition) {
              alert(state.lang === "tr"
                ? "Bu tarayÄ±cÄ±da ses tanÄ±ma desteklenmiyor. (Chrome Ã¶nerilir)"
                : "Speech recognition is not supported.");
              return;
            }
            try {
              recognition.lang = LANG_SPEECH[state.lang] || "en-US";
              recognition.start();
            } catch {}
            voiceBtn.disabled = true;
            voiceBtn.textContent = "ğŸ¤â€¦";

            recognition.onresult = (ev) => {
              const text = ev.results?.[0]?.[0]?.transcript || "";
              if (messageInput && text) messageInput.value = (messageInput.value + " " + text).trim();
            };
            recognition.onerror = () => alert(state.lang === "tr" ? "Ses tanÄ±ma sÄ±rasÄ±nda hata oldu." : "Speech recognition error.");
            recognition.onend = () => { voiceBtn.disabled = false; voiceBtn.textContent = "ğŸ¤"; };
          });
        }

        // Camera
        if (cameraBtn && cameraFileInput) {
          cameraBtn.addEventListener("click", () => cameraFileInput.click());
          cameraFileInput.addEventListener("change", () => {
            const file = cameraFileInput.files?.[0];
            if (!file) return;
            const info = `[DOSYA: ${file.name}]`;
            if (messageInput) messageInput.value = messageInput.value ? messageInput.value + " " + info : info;
          });
        }

        // Trends
        if (refreshTrendsBtn) refreshTrendsBtn.addEventListener("click", loadTrends);

        // Series
        if (seriesGenerate && seriesTopic && seriesResult) {
          seriesGenerate.addEventListener("click", async () => {
            const topic = seriesTopic.value.trim();
            if (!topic) return;
            seriesResult.textContent = I18N[state.lang]?.loadingText || "YÃ¼kleniyor...";
            seriesResult.textContent = await callSimpleAPI("series", { topic, lang: LANG_NAMES[state.lang] || "Turkish" });
          });
        }

        // HOOK (FREE => AD => RESULT)  âœ… kredi dÃ¼ÅŸmez
        if (hookGenerate && hookTopic && hookResult) {
          hookGenerate.addEventListener("click", async () => {
            const topic = hookTopic.value.trim();
            if (!topic) return;

            const t = I18N[state.lang] || I18N.tr;

            const run = async () => {
              hookResult.textContent = t.loadingText || "YÃ¼kleniyor...";
              hookResult.textContent = await callSimpleAPI("hook", { topic, lang: LANG_NAMES[state.lang] || "Turkish" });
            };

            if (state.plan === "pro") return run();

            hookResult.textContent = t.adPlayingText || "Reklam izleniyorâ€¦ Bitince sonuÃ§ gelecek.";
            startRewardAd("generate", run);
          });
        }

        // COPY (FREE => AD => RESULT) âœ… kredi dÃ¼ÅŸmez
        if (copyGenerate && copyTopic && copyResult) {
          copyGenerate.addEventListener("click", async () => {
            const topic = copyTopic.value.trim();
            if (!topic) return;

            const t = I18N[state.lang] || I18N.tr;

            const run = async () => {
              copyResult.textContent = t.loadingText || "YÃ¼kleniyor...";
              copyResult.textContent = await callSimpleAPI("copy", { topic, lang: LANG_NAMES[state.lang] || "Turkish" });
            };

            if (state.plan === "pro") return run();

            copyResult.textContent = t.adPlayingText || "Reklam izleniyorâ€¦ Bitince sonuÃ§ gelecek.";
            startRewardAd("generate", run);
          });
        }

        // PRO tools: email header + pro required handling
        async function runProTool(route, inputValue, outEl) {
          const t = I18N[state.lang] || I18N.tr;
          const emailSafe = getEmailSafe();
          if (!emailSafe) {
            // open onboarding email step
            if (onboardingOverlay) onboardingOverlay.classList.remove("hidden");
            if (onboardStepLang) onboardStepLang.classList.add("hidden");
            if (onboardStepEmail) onboardStepEmail.classList.remove("hidden");
            setTimeout(() => { try { onboardEmailInput && onboardEmailInput.focus(); } catch {} }, 50);
            outEl.textContent = state.lang === "tr" ? "PRO aracÄ± iÃ§in e-posta ile giriÅŸ yapmalÄ±sÄ±n." : "You need to login with email first.";
            return;
          }
          outEl.textContent = t.loadingText || "YÃ¼kleniyor...";
          outEl.textContent = await callSimpleAPI(route, { input: inputValue, lang: LANG_NAMES[state.lang] || "Turkish", plan: state.plan }, { useEmailHeader: true });
        }

        if (proCompetitorBtn && proCompetitorInput && proCompetitorResult) {
          proCompetitorBtn.addEventListener("click", async () => {
            const v = proCompetitorInput.value.trim();
            if (!v) return;
            await runProTool("pro-competitor", v, proCompetitorResult);
          });
        }

        if (proAudienceBtn && proAudienceInput && proAudienceResult) {
          proAudienceBtn.addEventListener("click", async () => {
            const v = proAudienceInput.value.trim();
            if (!v) return;
            await runProTool("pro-audience", v, proAudienceResult);
          });
        }

        if (proSilentBtn && proSilentInput && proSilentResult) {
          proSilentBtn.addEventListener("click", async () => {
            const v = proSilentInput.value.trim();
            if (!v) return;
            await runProTool("pro-silent", v, proSilentResult);
          });
        }

        // CHAT submit => kredi sadece burada dÃ¼ÅŸer âœ…
        if (chatForm && topicInput && platformSelect && messageInput && loadingEl) {
          chatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const t = I18N[state.lang] || I18N.tr;

            const topic = (topicInput.value || "").trim();
            const extra = (messageInput.value || "").trim();
            const platform = platformSelect.value || "tiktok";

            const basePrompt = extra ? `${topic}\n\n${extra}` : topic;
            if (!basePrompt) return;

            if (state.plan === "free" && state.credits <= 0) {
              alert(t.freeNoCreditsAlert);
              return;
            }

            const prompt = state.plan === "pro"
              ? "[PRO_USER] KullanÄ±cÄ± PRO planda. Daha detaylÄ±, Ã¶zgÃ¼n, ileri seviye kÄ±sa video fikirleri Ã¼ret.\n\n" + basePrompt
              : basePrompt;

            addMessage("user", prompt);
            loadingEl.classList.remove("hidden");

            const reply = await callIdeasAPI(prompt, platform, state.lang);

            addMessage("assistant", reply);
            loadingEl.classList.add("hidden");

            if (state.plan === "free") {
              state.credits = Math.max(0, state.credits - 1);
              saveCredits();
              updatePlanAndCreditsUI();
            }

            topicInput.value = "";
            messageInput.value = "";
          });
        }

        // History trick (web back)
        if (window.history && window.history.pushState) {
          history.pushState({ screen: "root" }, "");
          window.addEventListener("popstate", () => {
            if (window.__inspireHandleBack && window.__inspireHandleBack()) {
              history.pushState({ screen: "root" }, "");
            }
          });
        }
      });
    </script>

    <!-- PWA: Service Worker KaydÄ± -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(() => console.log("Service Worker yÃ¼klendi âœ”"))
          .catch((err) => console.error("SW hatasÄ±:", err));
      }
    </script>
  </body>
  </html>
